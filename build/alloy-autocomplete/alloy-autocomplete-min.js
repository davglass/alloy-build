AUI.add("alloy-autocomplete",function(N){var AB=N.Lang,Y=AB.isArray,K=AB.isString,r=AB.isNull,P=AB.isFunction,z=N.ClassNameManager.getClassName,n="alert",AA="circle",l="content",t="helper",f="icon",x="item",o="list",T="loading",i="autocomplete",j="no",u="reset",v="results",E="s",d="selected",U="circle-triangle-b",m=n,D=T,C=z(i,d),I=z(i,o,x),V=z(i,j,v),s=z(t,u),B=z(i,v),X=z(i,v,l),R=8,q=9,g=13,L=16,F=17,G=18,Q=20,h=27,J=33,M=35,b=36,p=38,a=40,Z=39,W=37,k=44,y=44,H=229,c={node:null,points:["tl","bl"]},w="boundingBox",e="contentBox";var O=function(){O.superclass.constructor.apply(this,arguments);};O.NAME=i;O.ATTRS={allowBrowserAutocomplete:{value:true},alwaysShowContainer:{value:false},autoHighlight:{value:true},applyLocalFilter:{value:null},button:{value:true},dataSource:{value:null},dataSourceType:{value:null},delimChar:{value:null,setter:function(A){if(K(A)&&(A.length>0)){A=[A];}else{if(!Y(A)){A=N.Attribute.INVALID_VALUE;}}return A;}},forceSelection:{value:false},input:{value:null},matchKey:{value:""},maxResultsDisplayed:{value:10},minQueryLength:{value:1},queryDelay:{value:0.2,getter:function(A){return A*1000;}},queryInterval:{value:0.5,getter:function(S){var A=this;return S*1000;}},queryMatchCase:{value:false},queryMatchContains:{value:false},queryQuestionMark:{value:true},resultTypeList:{value:true},schema:{value:null},schemaType:{value:"",validator:K},suppressInputUpdate:{value:false},typeAhead:{value:false},typeAheadDelay:{value:0.2,getter:function(A){return A*1000;}},uniqueName:{value:null}};N.extend(O,N.Widget,{initializer:function(S){var A=this;A._createDataSource();},renderUI:function(){var A=this;A._renderInput();A._renderOverlay();},bindUI:function(){var A=this;var S=A.button;var AC=A.inputNode;A.dataSource.on("request",N.bind(S.set,S,f,D));AC.on("blur",A._onTextboxBlur,A);AC.on("focus",A._onTextboxFocus,A);AC.on("keydown",A._onTextboxKeyDown,A);AC.on("keypress",A._onTextboxKeyPress,A);AC.on("keyup",A._onTextboxKeyUp,A);var AD=A.overlay.get(w);AD.on("click",A._onContainerClick,A);AD.on("mouseout",A._onContainerMouseout,A);AD.on("mouseover",A._onContainerMouseover,A);AD.on("scroll",A._onContainerScroll,A);A.publish("containerCollapse");A.publish("containerExpand");A.publish("containerPopulate");A.publish("dataError");A.publish("dataRequest");A.publish("dataReturn");A.publish("itemArrowFrom");A.publish("itemArrowTo");A.publish("itemMouseOut");A.publish("itemMouseOver");A.publish("itemSelect");A.publish("selectionEnforce");A.publish("textboxBlur");A.publish("textboxChange");A.publish("textboxFocus");A.publish("textboxKey");A.publish("typeAhead");A.publish("unmatchedItemSelect");A.overlay.on("visibleChange",A._realignContainer);},syncUI:function(){var A=this;A.inputNode.setAttribute("autocomplete","off");},doBeforeExpandContainer:function(){return true;},doBeforeLoadData:function(A){return true;},filterResults:function(AL){var AR=this;var AC=AL.callback;var AD=AL.request;var S=AL.response;if(AC&&AC.argument&&AC.argument.query){AD=AC.argument.query;}if(AD){var AQ=AR.dataSource;var AN=S.results;var A=[];var AF=false;var AE=AR.get("matchKey")||0;var AO=AR.get("queryMatchCase");var AJ=AR.get("queryMatchContains");var AI=(AD=="*");var AK=AR.get("schema.resultFields");for(var AM=AN.length-1;AM>=0;AM--){var AH=AN[AM];var AP=null;if(K(AH)){AP=AH;}else{if(Y(AH)){AP=AH[0];}else{if(AK){AP=AH[AE||AK[0]];}}}if(K(AP)){var AG=-1;if(AO){AG=AP.indexOf(decodeURIComponent(AD));}else{AG=AP.toLowerCase().indexOf(decodeURIComponent(AD).toLowerCase());}if((AI)||(!AJ&&(AG===0))||(AJ&&(AG>-1))){A.unshift(AH);}}}S.results=A;}return S;},formatResult:function(S,AC,A){return A||"";},generateRequest:function(A){return A;},handleResponse:function(AC){var S=this;S._populateList(AC);var A=U;if(AC.error){A=m;}S.button.set(f,A);},preparseRawResponse:function(A){},sendQuery:function(S){var A=this;A.set("focused",null);var AC=S;if(A.get("delimChar")){S=A.inputNode.get("value")+S;}A._sendQuery(AC);},_clearInterval:function(){var A=this;if(A._queryIntervalId){clearInterval(A._queryIntervalId);A._queryIntervalId=null;}},_clearSelection:function(){var S=this;var AC=S.get("delimChar");var A={previous:"",query:S.inputNode.get("value")};if(AC){A=S._extractQuery(S.inputNode.get("value"));}S.fire("selectionEnforce",A.query);},_createDataSource:function(){var A=this;var AG=A.get("dataSource");var AE=AG;var AF=A.get("dataSourceType");if(!(AG instanceof N.DataSource.Local)){if(!AF){AF="Local";if(P(AE)){AF="Function";}else{if(K(AE)){AF="IO";}}}AG=new N.DataSource[AF]({source:AE});}AG.on("error",A.handleResponse,A);AG.after("response",A.handleResponse,A);AF=AG.name;if(AF=="dataSourceLocal"){A.set("applyLocalFilter",true);}A.set("dataSource",AG);A.set("dataSource",AF);A.dataSource=AG;var AD=A.get("schema");if(AD){if(AD.fn){A.dataSource.plug(AD);}else{var S=A.get("schemaType");var AC={array:N.Plugin.DataSourceArraySchema,json:N.Plugin.DataSourceJSONSchema,text:N.Plugin.DataSourceTextSchema,xml:N.Plugin.DataSourceXMLSchema};S=S.toLowerCase()||"array";A.dataSource.plug({fn:AC[S],cfg:{schema:AD}});}}A.set("schema",AD);},_enableIntervalDetection:function(){var A=this;var S=A.get("queryInterval");if(!A._queryIntervalId&&S){A._queryInterval=setInterval(N.bind(A._onInterval,A),S);}},_extractQuery:function(AE){var AI=this;var AG=AI.get("delimChar");var A=-1;var AC=AG.length-1;var AH,AF,AD;for(;AC>=0;AC--){AH=AE.lastIndexOf(AG[AC]);if(AH>A){A=AH;}}if(AG[AC]==" "){for(var S=AG.length-1;S>=0;S--){if(AE[A-1]==AG[S]){A--;break;}}}if(A>-1){AF=A+1;while(AE.charAt(AF)==" "){AF+=1;}AD=AE.substring(0,AF);AE=AE.substring(AF);}else{AD="";}return{previous:AD,query:AE};},_focus:function(){var A=this;setTimeout(function(){A.inputNode.focus();},0);},_isIgnoreKey:function(S){var A=this;if((S==q)||(S==g)||(S==L)||(S==F)||(S>=G&&S<=Q)||(S==h)||(S>=J&&S<=M)||(S>=b&&S<=a)||(S>=k&&S<=y)||(S==H)){return true;}return false;},_jumpSelection:function(){var A=this;if(A._elCurListItem){A._selectItem(A._elCurListItem);}else{A._toggleContainer(false);}},_moveSelection:function(AN){var AK=this;
if(AK.overlay.get("visible")){var AO=AK._elCurListItem;var S=-1;if(AO){S=Number(AO.getAttribute("data-listItemIndex"));}var AC=S-1;if(AN==a){AC=S+1;}if(AC==-1){AC=AK._displayedItems-1;}if(AC>=AK._displayedItems){AC=0;}if(AC<-2){return;}if(AO){AK._toggleHighlight(AO,"from");AK.fire("itemArrowFrom",AO);}if(AC==-1){if(AK.get("delimChar")){AK.inputNode.set("value",AK._pastSelections+AK._currentQuery);}else{AK.inputNode.set("value",AK._currentQuery);}return;}if(AC==-2){AK._toggleContainer(false);return;}var AG=AK.resultList.get("childNodes").item(AC);var AE=AK.overlay.get(e);var AI=AE.getStyle("overflow");var AL=AE.getStyle("overflowY");var AD=(AI=="auto")||(AI=="scroll")||(AL=="auto")||(AL=="scroll");if(AD&&(AC>-1)&&(AC<AK._displayedItems)){var A=-1;var AP=AG.get("offsetTop");var AF=AP+AG.get("offsetHeight");var AJ=AE.get("offsetHeight");var AH=AE.get("scrollTop");var AM=AJ+AH;if(AN==a){if(AF>AM){A=(AF-AJ);}else{if(AF<AH){A=AP;}}}else{if(AP<AJ){A=AP;}else{if(AP>AM){A=(AF-AJ);}}}if(A>-1){AE.set("scrollTop",A);}}AK._toggleHighlight(AG,"to");AK.fire("itemArrowTo",AG);if(AK.get("typeAhead")){AK._updateValue(AG);}}},_onButtonMouseDown:function(S){var A=this;S.halt();A._focus();A._sendQuery(A.inputNode.get("value")+"*");},_onContainerClick:function(AC){var A=this;var AD=AC.target;var S=AD.get("nodeName").toLowerCase();AC.halt();while(AD&&(S!="table")){switch(S){case"body":return;case"li":A._toggleHighlight(AD,"to");A._selectItem(AD);return;default:break;}AD=AD.get("parentNode");if(AD){S.get("nodeName").toLowerCase();}}},_onContainerMouseout:function(AC){var A=this;var AD=AC.target;var S=AD.get("nodeName").toLowerCase();while(AD&&(S!="table")){switch(S){case"body":return;case"li":A._toggleHighlight(AD,"from");A.fire("itemMouseOut",AD);break;case"ul":A._toggleHighlight(A._elCurListItem,"to");break;case"div":if(AD.hasClass(B)){A._overContainer=false;return;}break;default:break;}AD=AD.get("parentNode");if(AD){S=AD.get("nodeName").toLowerCase();}}},_onContainerMouseover:function(AC){var A=this;var AD=AC.target;var S=AD.get("nodeName").toLowerCase();while(AD&&(S!="table")){switch(S){case"body":return;case"li":A._toggleHighlight(AD,"to");A.fire("itemMouseOut",AD);break;case"div":if(AD.hasClass(B)){A._overContainer=true;return;}break;default:break;}AD=AD.get("parentNode");if(AD){S=AD.get("nodeName").toLowerCase();}}},_onContainerScroll:function(S){var A=this;A._focus();},_onInterval:function(){var A=this;var AC=A.inputNode.get("value");var S=A._lastValue;if(AC!=S){A._lastValue=AC;A._sendQuery(AC);}},_onTextboxBlur:function(AD){var A=this;if(!A._overContainer||(A._keyCode==q)){if(!A._itemSelected){var AC=A._textMatchesOption();var S=A.overlay.get("visible");if(!S||(S&&r(AC))){if(A.get("forceSelection")){A._clearSelection();}else{A.fire("unmatchedItemSelect",A._currentQuery);}}else{if(A.get("forceSelection")){A._selectItem(AC);}}}A._clearInterval();A.blur();if(A._initInputValue!==A.inputNode.get("value")){A.fire("textboxChange");}A.fire("textboxBlur");A._toggleContainer(false);}else{A._focus();}},_onTextboxFocus:function(S){var A=this;if(!A.get("focused")){A.inputNode.setAttribute("autocomplete","off");A.focus();A._initInputValue=A.inputNode.get("value");A.fire("textboxFocus");}},_onTextboxKeyDown:function(S){var A=this;var AC=S.keyCode;if(A._typeAheadDelayId!=-1){clearTimeout(A._typeAheadDelayId);}switch(AC){case q:if(A._elCurListItem){if(A.get("delimChar")&&A._keyCode!=AC){if(A.overlay.get("visible")){S.halt();}}A._selectItem(A._elCurListItem);}else{A._toggleContainer(false);}break;case g:if(A._elCurListItem){if(A._keyCode!=AC){if(A.overlay.get("visible")){S.halt();}}A._selectItem(A._elCurListItem);}else{A._toggleContainer(false);}break;case h:A._toggleContainer(false);return;case p:if(A.overlay.get("visible")){S.halt();A._moveSelection(AC);}break;case Z:A._jumpSelection();break;case a:if(A.overlay.get("visible")){S.halt();A._moveSelection(AC);}break;default:A._itemSelected=false;A._toggleHighlight(A._elCurListItem,"from");A.fire("textboxKey",AC);break;}if(AC==G){A._enableIntervalDetection();}A._keyCode=AC;},_onTextboxKeyPress:function(S){var A=this;var AC=S.keyCode;switch(AC){case q:if(A.overlay.get("visible")){if(A.get("delimChar")){S.halt();}if(A._elCurListItem){A._selectItem(A._elCurListItem);}else{A._toggleContainer(false);}}break;case 13:if(A.overlay.get("visible")){S.halt();if(A._elCurListItem){A._selectItem(A._elCurListItem);}else{A._toggleContainer(false);}}break;default:break;}if(AC==H){A._enableIntervalDetection();}},_onTextboxKeyUp:function(AC){var A=this;var S=A.inputNode;var AD=S.get("value");var AE=AC.keyCode;if(A._isIgnoreKey(AE)){return;}if(A._delayId!=-1){clearTimeout(A._delayId);}A._delayId=setTimeout(function(){A._sendQuery(AD);},A.get("queryDelay"));},_populateList:function(A){var AL=this;if(AL._typeAheadDelayId!=-1){clearTimeout(AL._typeAheadDelayId);}var AG=A.request;var AE=A.response;var AO=A.callback;var AD=(AG=="*");if(AO&&AO.argument&&AO.argument.query){A.request=AG=AO.argument.query;}var AJ=AL.doBeforeLoadData(A);if(AJ&&!A.error){AL.fire("dataReturn",A);var AI=AL.get("focused");if(AD||AI||AI===null){var AH=decodeURIComponent(AG);AL._currentQuery=AH;AL._itemSelected=false;var AC=A.response.results;var AN=Math.min(AC.length,AL.get("maxResultsDisplayed"));var AF=AL.get("schema.resultFields");var AM=AL.get("matchKey");if(!AM&&AF){AM=AF[0];}else{AM=AM||0;}if(AN>0){var AK=AL.resultList.get("childNodes");AK.each(function(AT,AS,AR){if(AS<AN){var AQ=AC[AS];var AP="";if(K(AQ)){AP=AQ;}else{if(Y(AQ)){AP=AQ[0];}else{AP=AQ[AM];}}AT._resultMatch=AP;AT._resultData=AQ;AT.html(AL.formatResult(AQ,AH,AP));AT.removeClass("aui-helper-hidden");}else{AT.addClass("aui-helper-hidden");}});AL._displayedItems=AN;AL.fire("containerPopulate",AG,AC);if(AG!="*"&&AL.get("autoHighlight")){var S=AL.resultList.get("firstChild");AL._toggleHighlight(S,"to");AL.fire("itemArrowTo",S);AL._typeAhead(S,AG);}else{AL._toggleHighlight(AL._elCurListItem,"from");}AJ=AL.doBeforeExpandContainer(AG,AC);AL._toggleContainer(AJ);}else{AL._toggleContainer(false);
}return;}}else{AL.fire("dataError",AG);}},_realignContainer:function(S){var A=this;A._uiSetAlign(c.node,c.points);},_renderInput:function(){var S=this;var AC=S.get(e);var AD=S.get("input");var AF={field:{labelText:false},tools:[{icon:"circle-triangle-b",id:"trigger",handler:{fn:S._onButtonMouseDown,context:S}}]};var AE=null;var A=null;if(AD){AD=N.get(AD);AF.field.node=AD;AE=AD.next();A=AD.get("parentNode");}var AG=new N.Combobox(AF).render(AC);if(A){var AH=AG.get("boundingBox");A.insertBefore(AH,AE);}S.inputNode=AG.get("node");S.button=AG.toolset.tools.item("trigger");S.set("uniqueName",N.stamp(S.inputNode));},_renderListElements:function(){var A=this;var AD=A.get("maxResultsDisplayed");var S=A.resultList;var AC=[];while(AD--){AC[AD]='<li class="aui-helper-hidden '+I+'" data-listItemIndex="'+AD+'"></li>';}S.html(AC.join(""));},_renderOverlay:function(){var A=this;c.node=A.inputNode;var AC=new N.Overlay({align:c,bodyContent:"<ul></ul>",visible:false,width:A.inputNode.get("offsetWidth")});var S=AC.get(e);AC.get(w).addClass(B);S.addClass(X);AC.render(document.body);AC.addTarget(A);A.overlay=AC;A.resultList=S.query("ul");A.resultList.addClass(s);A._renderListElements();},_selectItem:function(S){var A=this;A._itemSelected=true;A._updateValue(S);A._pastSelections=A.inputNode.get("value");A._clearInterval();A.fire("itemSelect",S,S._resultData);A._toggleContainer(false);},_selectText:function(AE,AG,AC){var A=this;var S=N.Node.getDOMNode(AE);var AF=AE.get("value");if(S.setSelectionRange){S.setSelectionRange(AG,AC);}else{if(S.createTextRange){var AD=S.createTextRange();AD.moveStart("character",AG);AD.moveEnd("character",AC-AF.length);AD.select();}else{S.select();}}},_sendQuery:function(AF){var S=this;if(S.get("disabled")){S._toggleContainer(false);return;}var AD=S.get("delimChar");var AC=S.get("minQueryLength");if(AD){var A=S._extractQuery(AF);AF=A.query;S._pastSelections=A.previous;}if((AF&&(AF.length<AC))||(!AF&&AC>0)){if(S._delayId!=-1){clearTimeout(S._delayId);}S._toggleContainer(false);return;}AF=encodeURIComponent(AF);S._delayId=-1;if(S.get("applyLocalFilter")){S.dataSource.on("response",S.filterResults,S);}var AE=S.generateRequest(AF);S.fire("dataRequest",AF,AE);S.dataSource.sendRequest(AE);},_textMatchesOption:function(){var A=this;var S=null;var AF=A._displayedItems;var AG=A.resultList.get("childNodes");for(var AD=0;AD<AF.length;AD++){var AE=AG.item(AD);var AC=(""+AE._resultMatch).toLowerCase();if(AC==A._currentQuery.toLowerCase()){S=AE;break;}}return S;},_toggleContainer:function(S){var A=this;var AC=A.overlay;if(A.get("alwaysShowContainer")&&AC.get("visible")){return;}if(!S){A._toggleHighlight(A._elCurListItem,"from");A._displayedItems=0;A._currentQuery=null;}if(S){AC.show();A.fire("containerExpand");}else{AC.hide();A.fire("containerCollapse");}},_toggleHighlight:function(S,AC){var A=this;if(S){if(A._elCurListItem){A._elCurListItem.removeClass(C);A._elCurListItem=null;}if(AC=="to"){S.addClass(C);A._elCurListItem=S;}}},_typeAhead:function(S,AC){var A=this;if(!A.get("typeAhead")||A._keyCode==R){return;}var AD=N.Node.getDOMNode(A.inputNode);if(AD.setSelectionRange||AD.createTextRange){A._typeAheadDelayId=setTimeout(function(){var AG=AD.value;var AH=AG.length;A._updateValue(S);var AE=AD.value.length;A._selectText(A.inputNode,AH,AE);var AF=AD.value.substr(AH,AE);A.fire("typeAhead",AC,AF);},A.get("typeAheadDelay"));}},_updateValue:function(AF){var S=this;if(!S.get("suppressInputUpdate")){var AE=S.inputNode;var A=AF._resultMatch;var AD=S.get("delimChar");AD=(AD&&AD[0])||AD;var AG="";if(AD){AG=S._pastSelections;AG+=A+AD;if(AD!=" "){AG+=" ";}}else{AG=A;}AE.set("value",AG);if(AE.get("type")=="textarea"){AE.set("scrollTop",AE.get("scrollHeight"));}var AC=AG.length;S._selectText(AE,AC,AC);S._elCurListItem=AF;}},_currentQuery:null,_delayId:-1,_displayedItems:0,_elCurListItem:null,_initInputValue:null,_itemSelected:false,_keyCode:null,_lastValue:null,_overContainer:false,_pastSelections:"",_typeAheadDelayId:-1});N.AutoComplete=O;},"@VERSION@",{requires:["datasource","dataschema","overlay","tool"]});